{
  "version": 3,
  "sources": ["../../../../../../../Dependency/Land/Dependency/Editor/Source/vs/editor/browser/gpu/objectCollectionBuffer.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { Disposable, dispose, toDisposable, type IDisposable } from '../../../base/common/lifecycle.js';\nimport { LinkedList } from '../../../base/common/linkedList.js';\nimport { BufferDirtyTracker, type IBufferDirtyTrackerReader } from './bufferDirtyTracker.js';\n\nexport interface ObjectCollectionBufferPropertySpec {\n\tname: string;\n}\n\nexport type ObjectCollectionPropertyValues<T extends ObjectCollectionBufferPropertySpec[]> = {\n\t[K in T[number]['name']]: number;\n};\n\nexport interface IObjectCollectionBuffer<T extends ObjectCollectionBufferPropertySpec[]> extends IDisposable {\n\t/**\n\t * The underlying buffer. This **should not** be modified externally.\n\t */\n\treadonly buffer: ArrayBuffer;\n\t/**\n\t * A view of the underlying buffer. This **should not** be modified externally.\n\t */\n\treadonly view: Float32Array;\n\t/**\n\t * The size of the used portion of the buffer (in bytes).\n\t */\n\treadonly bufferUsedSize: number;\n\t/**\n\t * The size of the used portion of the view (in float32s).\n\t */\n\treadonly viewUsedSize: number;\n\t/**\n\t * The number of entries in the buffer.\n\t */\n\treadonly entryCount: number;\n\n\t/**\n\t * A tracker for dirty regions in the buffer.\n\t */\n\treadonly dirtyTracker: IBufferDirtyTrackerReader;\n\n\t/**\n\t * Fires when the buffer is modified.\n\t */\n\treadonly onDidChange: Event<void>;\n\n\t/**\n\t * Fires when the buffer is recreated.\n\t */\n\treadonly onDidChangeBuffer: Event<void>;\n\n\t/**\n\t * Creates an entry in the collection. This will return a managed object that can be modified\n\t * which will update the underlying buffer.\n\t * @param data The data of the entry.\n\t */\n\tcreateEntry(data: ObjectCollectionPropertyValues<T>): IObjectCollectionBufferEntry<T>;\n}\n\n/**\n * An entry in an {@link ObjectCollectionBuffer}. Property values on the entry can be changed and\n * their values will be updated automatically in the buffer.\n */\nexport interface IObjectCollectionBufferEntry<T extends ObjectCollectionBufferPropertySpec[]> extends IDisposable {\n\tset(propertyName: T[number]['name'], value: number): void;\n\tget(propertyName: T[number]['name']): number;\n\tsetRaw(data: ArrayLike<number>): void;\n}\n\nexport function createObjectCollectionBuffer<T extends ObjectCollectionBufferPropertySpec[]>(\n\tpropertySpecs: T,\n\tcapacity: number\n): IObjectCollectionBuffer<T> {\n\treturn new ObjectCollectionBuffer<T>(propertySpecs, capacity);\n}\n\nclass ObjectCollectionBuffer<T extends ObjectCollectionBufferPropertySpec[]> extends Disposable implements IObjectCollectionBuffer<T> {\n\tbuffer: ArrayBuffer;\n\tview: Float32Array;\n\n\tget bufferUsedSize() {\n\t\treturn this.viewUsedSize * Float32Array.BYTES_PER_ELEMENT;\n\t}\n\tget viewUsedSize() {\n\t\treturn this._entries.size * this._entrySize;\n\t}\n\tget entryCount() {\n\t\treturn this._entries.size;\n\t}\n\n\tprivate _dirtyTracker = new BufferDirtyTracker();\n\tget dirtyTracker(): IBufferDirtyTrackerReader { return this._dirtyTracker; }\n\n\tprivate readonly _propertySpecsMap: Map<string, ObjectCollectionBufferPropertySpec & { offset: number }> = new Map();\n\tprivate readonly _entrySize: number;\n\tprivate readonly _entries: LinkedList<ObjectCollectionBufferEntry<T>> = new LinkedList();\n\n\tprivate readonly _onDidChange = this._register(new Emitter<void>());\n\treadonly onDidChange = this._onDidChange.event;\n\tprivate readonly _onDidChangeBuffer = this._register(new Emitter<void>());\n\treadonly onDidChangeBuffer = this._onDidChangeBuffer.event;\n\n\tconstructor(\n\t\tpublic propertySpecs: T,\n\t\tpublic capacity: number\n\t) {\n\t\tsuper();\n\n\t\tthis.view = new Float32Array(capacity * propertySpecs.length);\n\t\tthis.buffer = this.view.buffer;\n\t\tthis._entrySize = propertySpecs.length;\n\t\tfor (let i = 0; i < propertySpecs.length; i++) {\n\t\t\tconst spec = {\n\t\t\t\toffset: i,\n\t\t\t\t...propertySpecs[i]\n\t\t\t};\n\t\t\tthis._propertySpecsMap.set(spec.name, spec);\n\t\t}\n\t\tthis._register(toDisposable(() => dispose(this._entries)));\n\t}\n\n\tcreateEntry(data: ObjectCollectionPropertyValues<T>): IObjectCollectionBufferEntry<T> {\n\t\tif (this._entries.size === this.capacity) {\n\t\t\tthis._expandBuffer();\n\t\t\tthis._onDidChangeBuffer.fire();\n\t\t}\n\n\t\tconst value = new ObjectCollectionBufferEntry(this.view, this._propertySpecsMap, this._dirtyTracker, this._entries.size, data);\n\t\tconst removeFromEntries = this._entries.push(value);\n\t\tconst listeners: IDisposable[] = [];\n\t\tlisteners.push(Event.forward(value.onDidChange, this._onDidChange));\n\t\tlisteners.push(value.onWillDispose(() => {\n\t\t\tconst deletedEntryIndex = value.i;\n\t\t\tremoveFromEntries();\n\n\t\t\t// Shift all entries after the deleted entry to the left\n\t\t\tthis.view.set(this.view.subarray(deletedEntryIndex * this._entrySize + 2, this._entries.size * this._entrySize + 2), deletedEntryIndex * this._entrySize);\n\n\t\t\t// Update entries to reflect the new i\n\t\t\tfor (const entry of this._entries) {\n\t\t\t\tif (entry.i > deletedEntryIndex) {\n\t\t\t\t\tentry.i--;\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._dirtyTracker.flag(deletedEntryIndex, (this._entries.size - deletedEntryIndex) * this._entrySize);\n\t\t\tdispose(listeners);\n\t\t}));\n\t\treturn value;\n\t}\n\n\tprivate _expandBuffer() {\n\t\tthis.capacity *= 2;\n\t\tconst newView = new Float32Array(this.capacity * this._entrySize);\n\t\tnewView.set(this.view);\n\t\tthis.view = newView;\n\t\tthis.buffer = this.view.buffer;\n\t}\n}\n\nclass ObjectCollectionBufferEntry<T extends ObjectCollectionBufferPropertySpec[]> extends Disposable implements IObjectCollectionBufferEntry<T> {\n\n\tprivate readonly _onDidChange = this._register(new Emitter<void>());\n\treadonly onDidChange = this._onDidChange.event;\n\tprivate readonly _onWillDispose = this._register(new Emitter<void>());\n\treadonly onWillDispose = this._onWillDispose.event;\n\n\tconstructor(\n\t\tprivate _view: Float32Array,\n\t\tprivate _propertySpecsMap: Map<string, ObjectCollectionBufferPropertySpec & { offset: number }>,\n\t\tprivate _dirtyTracker: BufferDirtyTracker,\n\t\tpublic i: number,\n\t\tdata: ObjectCollectionPropertyValues<T>,\n\t) {\n\t\tsuper();\n\t\tfor (const propertySpec of this._propertySpecsMap.values()) {\n\t\t\tthis._view[this.i * this._propertySpecsMap.size + propertySpec.offset] = data[propertySpec.name as keyof typeof data];\n\t\t}\n\t\tthis._dirtyTracker.flag(this.i * this._propertySpecsMap.size, this._propertySpecsMap.size);\n\t}\n\n\toverride dispose() {\n\t\tthis._onWillDispose.fire();\n\t\tsuper.dispose();\n\t}\n\n\tset(propertyName: T[number]['name'], value: number): void {\n\t\tconst i = this.i * this._propertySpecsMap.size + this._propertySpecsMap.get(propertyName)!.offset;\n\t\tthis._view[this._dirtyTracker.flag(i)] = value;\n\t\tthis._onDidChange.fire();\n\t}\n\n\tget(propertyName: T[number]['name']): number {\n\t\treturn this._view[this.i * this._propertySpecsMap.size + this._propertySpecsMap.get(propertyName)!.offset];\n\t}\n\n\tsetRaw(data: ArrayLike<number>): void {\n\t\tif (data.length !== this._propertySpecsMap.size) {\n\t\t\tthrow new Error(`Data length ${data.length} does not match the number of properties in the collection (${this._propertySpecsMap.size})`);\n\t\t}\n\t\tthis._view.set(data, this.i * this._propertySpecsMap.size);\n\t\tthis._dirtyTracker.flag(this.i * this._propertySpecsMap.size, this._propertySpecsMap.size);\n\t}\n}\n"],
  "mappings": ";;AAKA,SAAS,SAAS,aAAa;AAC/B,SAAS,YAAY,SAAS,oBAAsC;AACpE,SAAS,kBAAkB;AAC3B,SAAS,0BAA0D;AAiE5D,SAAS,6BACf,eACA,UAC6B;AAC7B,SAAO,IAAI,uBAA0B,eAAe,QAAQ;AAC7D;AALgB;AAOhB,MAAM,+BAA+E,WAAiD;AAAA,EA0BrI,YACQ,eACA,UACN;AACD,UAAM;AAHC;AACA;AAIP,SAAK,OAAO,IAAI,aAAa,WAAW,cAAc,MAAM;AAC5D,SAAK,SAAS,KAAK,KAAK;AACxB,SAAK,aAAa,cAAc;AAChC,aAAS,IAAI,GAAG,IAAI,cAAc,QAAQ,KAAK;AAC9C,YAAM,OAAO;AAAA,QACZ,QAAQ;AAAA,QACR,GAAG,cAAc,CAAC;AAAA,MACnB;AACA,WAAK,kBAAkB,IAAI,KAAK,MAAM,IAAI;AAAA,IAC3C;AACA,SAAK,UAAU,aAAa,MAAM,QAAQ,KAAK,QAAQ,CAAC,CAAC;AAAA,EAC1D;AAAA,EA3HD,OAgFsI;AAAA;AAAA;AAAA,EACrI;AAAA,EACA;AAAA,EAEA,IAAI,iBAAiB;AACpB,WAAO,KAAK,eAAe,aAAa;AAAA,EACzC;AAAA,EACA,IAAI,eAAe;AAClB,WAAO,KAAK,SAAS,OAAO,KAAK;AAAA,EAClC;AAAA,EACA,IAAI,aAAa;AAChB,WAAO,KAAK,SAAS;AAAA,EACtB;AAAA,EAEQ,gBAAgB,IAAI,mBAAmB;AAAA,EAC/C,IAAI,eAA0C;AAAE,WAAO,KAAK;AAAA,EAAe;AAAA,EAE1D,oBAA0F,oBAAI,IAAI;AAAA,EAClG;AAAA,EACA,WAAuD,IAAI,WAAW;AAAA,EAEtE,eAAe,KAAK,UAAU,IAAI,QAAc,CAAC;AAAA,EACzD,cAAc,KAAK,aAAa;AAAA,EACxB,qBAAqB,KAAK,UAAU,IAAI,QAAc,CAAC;AAAA,EAC/D,oBAAoB,KAAK,mBAAmB;AAAA,EAqBrD,YAAY,MAA0E;AACrF,QAAI,KAAK,SAAS,SAAS,KAAK,UAAU;AACzC,WAAK,cAAc;AACnB,WAAK,mBAAmB,KAAK;AAAA,IAC9B;AAEA,UAAM,QAAQ,IAAI,4BAA4B,KAAK,MAAM,KAAK,mBAAmB,KAAK,eAAe,KAAK,SAAS,MAAM,IAAI;AAC7H,UAAM,oBAAoB,KAAK,SAAS,KAAK,KAAK;AAClD,UAAM,YAA2B,CAAC;AAClC,cAAU,KAAK,MAAM,QAAQ,MAAM,aAAa,KAAK,YAAY,CAAC;AAClE,cAAU,KAAK,MAAM,cAAc,MAAM;AACxC,YAAM,oBAAoB,MAAM;AAChC,wBAAkB;AAGlB,WAAK,KAAK,IAAI,KAAK,KAAK,SAAS,oBAAoB,KAAK,aAAa,GAAG,KAAK,SAAS,OAAO,KAAK,aAAa,CAAC,GAAG,oBAAoB,KAAK,UAAU;AAGxJ,iBAAW,SAAS,KAAK,UAAU;AAClC,YAAI,MAAM,IAAI,mBAAmB;AAChC,gBAAM;AAAA,QACP;AAAA,MACD;AACA,WAAK,cAAc,KAAK,oBAAoB,KAAK,SAAS,OAAO,qBAAqB,KAAK,UAAU;AACrG,cAAQ,SAAS;AAAA,IAClB,CAAC,CAAC;AACF,WAAO;AAAA,EACR;AAAA,EAEQ,gBAAgB;AACvB,SAAK,YAAY;AACjB,UAAM,UAAU,IAAI,aAAa,KAAK,WAAW,KAAK,UAAU;AAChE,YAAQ,IAAI,KAAK,IAAI;AACrB,SAAK,OAAO;AACZ,SAAK,SAAS,KAAK,KAAK;AAAA,EACzB;AACD;AAEA,MAAM,oCAAoF,WAAsD;AAAA,EAO/I,YACS,OACA,mBACA,eACD,GACP,MACC;AACD,UAAM;AANE;AACA;AACA;AACD;AAIP,eAAW,gBAAgB,KAAK,kBAAkB,OAAO,GAAG;AAC3D,WAAK,MAAM,KAAK,IAAI,KAAK,kBAAkB,OAAO,aAAa,MAAM,IAAI,KAAK,aAAa,IAAyB;AAAA,IACrH;AACA,SAAK,cAAc,KAAK,KAAK,IAAI,KAAK,kBAAkB,MAAM,KAAK,kBAAkB,IAAI;AAAA,EAC1F;AAAA,EAtLD,OAmKgJ;AAAA;AAAA;AAAA,EAE9H,eAAe,KAAK,UAAU,IAAI,QAAc,CAAC;AAAA,EACzD,cAAc,KAAK,aAAa;AAAA,EACxB,iBAAiB,KAAK,UAAU,IAAI,QAAc,CAAC;AAAA,EAC3D,gBAAgB,KAAK,eAAe;AAAA,EAgBpC,UAAU;AAClB,SAAK,eAAe,KAAK;AACzB,UAAM,QAAQ;AAAA,EACf;AAAA,EAEA,IAAI,cAAiC,OAAqB;AACzD,UAAM,IAAI,KAAK,IAAI,KAAK,kBAAkB,OAAO,KAAK,kBAAkB,IAAI,YAAY,EAAG;AAC3F,SAAK,MAAM,KAAK,cAAc,KAAK,CAAC,CAAC,IAAI;AACzC,SAAK,aAAa,KAAK;AAAA,EACxB;AAAA,EAEA,IAAI,cAAyC;AAC5C,WAAO,KAAK,MAAM,KAAK,IAAI,KAAK,kBAAkB,OAAO,KAAK,kBAAkB,IAAI,YAAY,EAAG,MAAM;AAAA,EAC1G;AAAA,EAEA,OAAO,MAA+B;AACrC,QAAI,KAAK,WAAW,KAAK,kBAAkB,MAAM;AAChD,YAAM,IAAI,MAAM,eAAe,KAAK,MAAM,+DAA+D,KAAK,kBAAkB,IAAI,GAAG;AAAA,IACxI;AACA,SAAK,MAAM,IAAI,MAAM,KAAK,IAAI,KAAK,kBAAkB,IAAI;AACzD,SAAK,cAAc,KAAK,KAAK,IAAI,KAAK,kBAAkB,MAAM,KAAK,kBAAkB,IAAI;AAAA,EAC1F;AACD;",
  "names": []
}
