var U=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var L=(h,c,e,i)=>{for(var o=i>1?void 0:i?B(c,e):c,a=h.length-1,r;a>=0;a--)(r=h[a])&&(o=(i?r(c,e,o):r(o))||o);return i&&o&&U(c,e,o),o},v=(h,c)=>(e,i)=>c(e,i,h);import{h as m}from"../../../../../../base/browser/dom.js";import{renderIcon as H}from"../../../../../../base/browser/ui/iconLabel/iconLabels.js";import{numberComparator as G}from"../../../../../../base/common/arrays.js";import{findFirstMin as z}from"../../../../../../base/common/arraysFind.js";import{Codicon as $}from"../../../../../../base/common/codicons.js";import{createHotClass as q}from"../../../../../../base/common/hotReloadHelpers.js";import{Disposable as R}from"../../../../../../base/common/lifecycle.js";import{autorun as T,constObservable as I,derived as f,derivedDisposable as M,derivedWithCancellationToken as V,observableFromEvent as J,ObservablePromise as j}from"../../../../../../base/common/observable.js";import{getIndentationLength as K,splitLines as Q}from"../../../../../../base/common/strings.js";import{MenuWorkbenchToolBar as X}from"../../../../../../platform/actions/browser/toolbar.js";import{MenuId as Y,MenuItemAction as Z}from"../../../../../../platform/actions/common/actions.js";import{IInstantiationService as O}from"../../../../../../platform/instantiation/common/instantiation.js";import"../../../../../browser/editorBrowser.js";import{observableCodeEditor as _}from"../../../../../browser/observableCodeEditor.js";import{EmbeddedCodeEditorWidget as ee}from"../../../../../browser/widget/codeEditor/embeddedCodeEditorWidget.js";import{IDiffProviderFactoryService as ie}from"../../../../../browser/widget/diffEditor/diffProviderFactoryService.js";import{diffAddDecoration as te,diffAddDecorationEmpty as oe,diffDeleteDecorationEmpty as ne,diffWholeLineAddDecoration as re,diffWholeLineDeleteDecoration as se}from"../../../../../browser/widget/diffEditor/registrations.contribution.js";import{appendRemoveOnDispose as ae,applyStyle as de}from"../../../../../browser/widget/diffEditor/utils.js";import{EditorOption as le}from"../../../../../common/config/editorOptions.js";import{LineRange as S}from"../../../../../common/core/lineRange.js";import{OffsetRange as C}from"../../../../../common/core/offsetRange.js";import{Position as ce}from"../../../../../common/core/position.js";import{Range as b}from"../../../../../common/core/range.js";import{ArrayText as fe,SingleTextEdit as D,TextEdit as P}from"../../../../../common/core/textEdit.js";import{TextLength as W}from"../../../../../common/core/textLength.js";import{lineRangeMappingFromRangeMappings as pe,RangeMapping as x}from"../../../../../common/diff/rangeMapping.js";import"../../../../../common/model.js";import{TextModel as N}from"../../../../../common/model/textModel.js";import{TextModelText as k}from"../../../../../common/model/textModelText.js";import{IModelService as me}from"../../../../../common/services/model.js";import"../../model/inlineEdit.js";import"./inlineEditsView.css";import{applyEditToModifiedRangeMappings as he,maxLeftInRange as F,Point as E,StatusBarViewItem as ge,UniqueUriGenerator as ue}from"./utils.js";let u=class extends R{constructor(e,i,o,a,r){super();this._editor=e;this._edit=i;this._instantiationService=o;this._diffProviderFactoryService=a;this._modelService=r;this._register(new y(this._editor,this._inlineEdit,this._instantiationService))}static hot=q(u);_modelUriGenerator=new ue("inline-edits");_originalModel=M(()=>this._modelService.createModel("",null,this._modelUriGenerator.getUniqueUri())).keepObserved(this._store);_modifiedModel=M(()=>this._modelService.createModel("",null,this._modelUriGenerator.getUniqueUri())).keepObserved(this._store);_inlineEditPromise=V(this,(e,i)=>{const o=this._edit.read(e);if(!o)return;const a=o.range;if(o.text.trim()==="")return;this._originalModel.get().setValue(this._editor.getModel().getValueInRange(a)),this._modifiedModel.get().setValue(o.text);const r=this._diffProviderFactoryService.createDiffProvider({diffAlgorithm:"advanced"});return j.fromFn(async()=>{const t=await r.computeDiff(this._originalModel.get(),this._modifiedModel.get(),{computeMoves:!1,ignoreTrimWhitespace:!1,maxComputationTimeMs:1e3},i);if(t.identical)return;const n=b.lift(o.range).getStartPosition(),d=t.changes.flatMap(s=>s.innerChanges);function p(s,l){const w=W.fromPosition(l.getStartPosition());return W.ofRange(l).createRange(w.addToPosition(s))}const g=d.map(s=>new D(p(n,s.originalRange),this._modifiedModel.get().getValueInRange(s.modifiedRange)));return new ve(new P(g))})});_inlineEdit=this._inlineEditPromise.map((e,i)=>e?.promiseResult?.read(i)?.data)};u=L([v(2,O),v(3,ie),v(4,me)],u);class ve{constructor(c){this.diffedTextEdit=c}originalLineRange=S.fromRangeInclusive(x.fromEditJoin(this.diffedTextEdit).originalRange);modifiedLineRange=S.fromRangeInclusive(x.fromEditJoin(this.diffedTextEdit).modifiedRange)}let y=class extends R{constructor(e,i,o){super();this._editor=e;this._edit=i;this._instantiationService=o;const a=f(this,t=>this._edit.read(t)!==void 0);this._register(de(this._elements.root,{display:f(this,t=>a.read(t)?"block":"none")})),this._register(ae(this._editor.getDomNode(),this._elements.root)),this._register(_(e).createOverlayWidget({domNode:this._elements.root,position:I(null),allowEditorOverflow:!1,minContentWidthInPx:f(t=>{const n=this._layout1.read(t)?.left;if(n===void 0)return 0;const d=this._previewEditorWidth.read(t);return n+d})})),this._register(_(e).createOverlayWidget({domNode:this._indicator.root,position:I(null),allowEditorOverflow:!1,minContentWidthInPx:I(0)})),this._previewEditor.setModel(this._previewTextModel),this._register(this._previewEditorObs.setDecorations(this._decorations.map(t=>t?.modifiedDecorations??[]))),this._register(_(e).setDecorations(this._decorations.map(t=>t?.originalDecorations??[]))),this._register(T(t=>{const n=this._layout.read(t);if(!n){this._indicator.root.style.visibility="hidden";return}this._indicator.root.style.visibility="";const{topEdit:d,editHeight:p}=n;this._elements.editorContainer.style.top=`${d.y}px`,this._elements.editorContainer.style.left=`${d.x}px`;const g=this._previewEditorWidth.read(t);this._previewEditor.layout({height:p,width:g});const s=this._editorObs.layoutInfo.read(t),l=new C(0,s.height-30);this._indicator.root.classList.toggle("top",d.y<l.start),this._indicator.root.classList.toggle("bottom",d.y>l.endExclusive),this._indicator.root.classList.toggle("contained",l.contains(d.y)),this._indicator.root.style.top=`${l.clip(d.y)}px`,this._indicator.root.style.right=`${s.minimap.minimapWidth+s.verticalScrollbarWidth}px`}));const r=J(this,this._toolbar.onDidChangeDropdownVisibility,t=>t??!1);this._register(T(t=>{this._elements.root.classList.toggle("toolbarDropdownVisible",r.read(t))}))}_editorObs=_(this._editor);_elements=m("div.inline-edits-view",{style:{position:"absolute",overflow:"visible",top:"0px",left:"0px"}},[m("div.editorContainer@editorContainer",{style:{position:"absolute"}},[m("div.preview@editor",{style:{}}),m("div.toolbar@toolbar",{style:{}})])]);_indicator=m("div.inline-edits-view-indicator",{style:{position:"absolute",overflow:"visible"}},[m("div.icon",{},[H($.arrowLeft)]),m("div.label",{},[" inline edit"])]);_previewEditorWidth=f(this,e=>{const i=this._edit.read(e);return i?F(this._previewEditorObs,i.modifiedLineRange,e):0});_uiState=f(this,e=>{const i=this._edit.read(e);if(!i)return;let o=i.diffedTextEdit.apply(new k(this._editor.getModel())),a=x.fromEdit(i.diffedTextEdit);const r=Q(o);function t(s,l){return new b(l.lineNumber,l.column+s.start,l.lineNumber,l.column+s.endExclusive)}const n=[],d=z(i.modifiedLineRange.mapToLineArray(s=>K(r[s-1])),G);i.modifiedLineRange.forEach(s=>{n.push(new D(t(new C(0,d),new ce(s,1)),""))});const p=new P(n);return o=p.applyToString(o),a=he(a,p),{diff:pe(a,new k(this._editor.getModel()),new fe(r)),edit:i,newText:o,newTextLineCount:i.modifiedLineRange.length}});_toolbar=this._register(this._instantiationService.createInstance(X,this._elements.toolbar,Y.InlineEditsActions,{menuOptions:{renderShortTitle:!0},toolbarOptions:{primaryGroup:e=>e.startsWith("primary")},actionViewItemProvider:(e,i)=>{if(e instanceof Z)return this._instantiationService.createInstance(ge,e,void 0)}}));_previewTextModel=this._register(this._instantiationService.createInstance(N,"",this._editor.getModel().getLanguageId(),{...N.DEFAULT_CREATION_OPTIONS,bracketPairColorizationOptions:{enabled:!0,independentColorPoolPerBracketType:!1}},null));_previewEditor=this._register(this._instantiationService.createInstance(ee,this._elements.editor,{glyphMargin:!1,lineNumbers:"off",minimap:{enabled:!1},guides:{indentation:!1,bracketPairs:!1,bracketPairsHorizontal:!1,highlightActiveIndentation:!1},folding:!1,selectOnLineNumbers:!1,selectionHighlight:!1,columnSelection:!1,overviewRulerBorder:!1,overviewRulerLanes:0,lineDecorationsWidth:0,lineNumbersMinChars:0,bracketPairColorization:{enabled:!0,independentColorPoolPerBracketType:!1},scrollBeyondLastLine:!1,scrollbar:{vertical:"hidden",horizontal:"hidden"},readOnly:!0},{contributions:[]},this._editor));_previewEditorObs=_(this._previewEditor);_ensureModelTextIsSet=f(e=>{const i=this._uiState.read(e);if(!i)return;this._previewTextModel.setValue(i.newText);const o=i.edit.originalLineRange;this._previewEditor.setHiddenAreas([new b(1,1,o.startLineNumber-1,1),new b(o.startLineNumber+i.newTextLineCount,1,this._previewTextModel.getLineCount()+1,1)],void 0,!0)}).recomputeInitiallyAndOnChange(this._store);_decorations=f(this,e=>{this._ensureModelTextIsSet.read(e);const i=this._uiState.read(e);if(!i)return;const o=i.diff,a=[],r=[];for(const t of o)if(t.modified.isEmpty||t.original.isEmpty)t.original.isEmpty||a.push({range:t.original.toInclusiveRange(),options:se}),t.modified.isEmpty||r.push({range:t.modified.toInclusiveRange(),options:re});else for(const n of t.innerChanges||[])t.original.contains(n.originalRange.startLineNumber)&&a.push({range:n.originalRange,options:n.originalRange.isEmpty()?ne:{className:"char-delete",description:"char-delete",shouldFillLineOnLineBreak:!1}}),t.modified.contains(n.modifiedRange.startLineNumber)&&r.push({range:n.modifiedRange,options:n.modifiedRange.isEmpty()?oe:te});return{originalDecorations:a,modifiedDecorations:r}});_layout1=f(this,e=>{const i=this._edit.read(e);if(!i)return null;const o=F(this._editorObs,i.originalLineRange,e);return{left:this._editorObs.layoutInfoContentLeft.read(e)+o}});_layout=f(this,e=>{const i=this._edit.read(e);if(!i)return null;const o=i.originalLineRange,a=this._editorObs.scrollLeft.read(e),r=this._layout1.read(e).left+20-a,t=this._editor.getTopForLineNumber(o.startLineNumber)-this._editorObs.scrollTop.read(e),n=this._editor.getTopForLineNumber(o.endLineNumberExclusive)-this._editorObs.scrollTop.read(e),d=new E(r,t),p=new E(r,n),g=n-t,s=50,l=this._editor.getOption(le.lineHeight)*i.modifiedLineRange.length,w=new E(r+s,t),A=new E(r+s,n);return{topCode:d,bottomCode:p,codeHeight:g,topEdit:w,bottomEdit:A,editHeight:l}})};y=L([v(2,O)],y);export{ve as InlineEditWithChanges,y as InlineEditsView,u as InlineEditsViewAndDiffProducer};
