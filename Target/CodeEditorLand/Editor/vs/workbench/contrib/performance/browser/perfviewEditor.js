var y=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var v=(p,t,e,r)=>{for(var i=r>1?void 0:r?k(t,e):t,n=p.length-1,a;n>=0;n--)(a=p[n])&&(i=(r?a(t,e,i):a(i))||i);return r&&i&&y(t,e,i),i},s=(p,t)=>(e,r)=>t(e,r,p);import{localize as _}from"../../../../nls.js";import{URI as w}from"../../../../base/common/uri.js";import{TextResourceEditorInput as T}from"../../../common/editor/textResourceEditorInput.js";import{ITextModelService as g}from"../../../../editor/common/services/resolverService.js";import"../../../../editor/common/model.js";import{ILifecycleService as M,LifecyclePhase as l,StartupKindToString as x}from"../../../services/lifecycle/common/lifecycle.js";import{ILanguageService as $}from"../../../../editor/common/languages/language.js";import{IInstantiationService as R}from"../../../../platform/instantiation/common/instantiation.js";import{IModelService as C}from"../../../../editor/common/services/model.js";import{ITimerService as E}from"../../../services/timer/browser/timerService.js";import{IExtensionService as W}from"../../../services/extensions/common/extensions.js";import{dispose as B}from"../../../../base/common/lifecycle.js";import{ICodeEditorService as P}from"../../../../editor/browser/services/codeEditorService.js";import{writeTransientState as D}from"../../codeEditor/browser/toggleWordWrap.js";import{IProductService as L}from"../../../../platform/product/common/productService.js";import{ITextFileService as A}from"../../../services/textfile/common/textfiles.js";import{IEditorService as F}from"../../../services/editor/common/editorService.js";import{ByteSize as u,IFileService as U}from"../../../../platform/files/common/files.js";import{ILabelService as G}from"../../../../platform/label/common/label.js";import{isWeb as S}from"../../../../base/common/platform.js";import{IFilesConfigurationService as K}from"../../../services/filesConfiguration/common/filesConfigurationService.js";import{ITerminalService as N}from"../../terminal/browser/terminal.js";import"../../../../base/common/performance.js";import{ITextResourceConfigurationService as j}from"../../../../editor/common/services/textResourceConfiguration.js";import{Registry as b}from"../../../../platform/registry/common/platform.js";import{Extensions as I,getWorkbenchContribution as z}from"../../../common/contributions.js";import{ICustomEditorLabelService as O}from"../../../services/editor/common/customEditorLabelService.js";import{IRemoteAgentService as V}from"../../../services/remote/common/remoteAgentService.js";let c=class{constructor(t,e){this._instaService=t;this._registration=e.registerTextModelContentProvider("perf",t.createInstance(h))}static get(){return z(c.ID)}static ID="workbench.contrib.perfview";_inputUri=w.from({scheme:"perf",path:"Startup Performance"});_registration;dispose(){this._registration.dispose()}getInputUri(){return this._inputUri}getEditorInput(){return this._instaService.createInstance(m)}};c=v([s(0,R),s(1,g)],c);let m=class extends T{static Id="PerfviewInput";get typeId(){return m.Id}constructor(t,e,r,i,n,a,o,d){super(c.get().getInputUri(),_("name","Startup Performance"),void 0,void 0,void 0,t,e,r,i,n,a,o,d)}};m=v([s(0,g),s(1,A),s(2,F),s(3,U),s(4,G),s(5,K),s(6,j),s(7,O)],m);let h=class{constructor(t,e,r,i,n,a,o,d,f){this._modelService=t;this._languageService=e;this._editorService=r;this._lifecycleService=i;this._timerService=n;this._extensionService=a;this._productService=o;this._remoteAgentService=d;this._terminalService=f}_model;_modelDisposables=[];provideTextContent(t){if(!this._model||this._model.isDisposed()){B(this._modelDisposables);const e=this._languageService.createById("markdown");this._model=this._modelService.getModel(t)||this._modelService.createModel("Loading...",e,t),this._modelDisposables.push(e.onDidChange(r=>{this._model?.setLanguage(r)})),this._modelDisposables.push(this._extensionService.onDidChangeExtensionsStatus(this._updateModel,this)),D(this._model,{wordWrapOverride:"off"},this._editorService)}return this._updateModel(),Promise.resolve(this._model)}_updateModel(){Promise.all([this._timerService.whenReady(),this._lifecycleService.when(l.Eventually),this._extensionService.whenInstalledExtensionsRegistered(),S&&!this._remoteAgentService.getConnection()?.remoteAuthority?Promise.resolve():this._terminalService.whenConnected]).then(()=>{if(this._model&&!this._model.isDisposed()){const t=new q;this._addSummary(t),t.blank(),this._addSummaryTable(t),t.blank(),this._addExtensionsTable(t),t.blank(),this._addPerfMarksTable("Terminal Stats",t,this._timerService.getPerformanceMarks().find(e=>e[0]==="renderer")?.[1].filter(e=>e.name.startsWith("code/terminal/"))),t.blank(),this._addWorkbenchContributionsPerfMarksTable(t),t.blank(),this._addRawPerfMarks(t),t.blank(),this._addResourceTimingStats(t),this._model.setValue(t.value)}})}_addSummary(t){const e=this._timerService.startupMetrics;t.heading(2,"System Info"),t.li(`${this._productService.nameShort}: ${this._productService.version} (${this._productService.commit||"0000000"})`),t.li(`OS: ${e.platform}(${e.release})`),e.cpus&&t.li(`CPUs: ${e.cpus.model}(${e.cpus.count} x ${e.cpus.speed})`),typeof e.totalmem=="number"&&typeof e.freemem=="number"&&t.li(`Memory(System): ${(e.totalmem/u.GB).toFixed(2)} GB(${(e.freemem/u.GB).toFixed(2)}GB free)`),e.meminfo&&t.li(`Memory(Process): ${(e.meminfo.workingSetSize/u.KB).toFixed(2)} MB working set(${(e.meminfo.privateBytes/u.KB).toFixed(2)}MB private, ${(e.meminfo.sharedBytes/u.KB).toFixed(2)}MB shared)`),t.li(`VM(likelihood): ${e.isVMLikelyhood}%`),t.li(`Initial Startup: ${e.initialStartup}`),t.li(`Has ${e.windowCount-1} other windows`),t.li(`Screen Reader Active: ${e.hasAccessibilitySupport}`),t.li(`Empty Workspace: ${e.emptyWorkbench}`)}_addSummaryTable(t){const e=this._timerService.startupMetrics,r=b.as(I.Workbench).timings,i=[];i.push(["start => app.isReady",e.timers.ellapsedAppReady,"[main]",`initial startup: ${e.initialStartup}`]),i.push(["nls:start => nls:end",e.timers.ellapsedNlsGeneration,"[main]",`initial startup: ${e.initialStartup}`]),i.push(["import(main.bundle.js)",e.timers.ellapsedLoadMainBundle,"[main]",`initial startup: ${e.initialStartup}`]),i.push(["start crash reporter",e.timers.ellapsedCrashReporter,"[main]",`initial startup: ${e.initialStartup}`]),i.push(["serve main IPC handle",e.timers.ellapsedMainServer,"[main]",`initial startup: ${e.initialStartup}`]),i.push(["create window",e.timers.ellapsedWindowCreate,"[main]",`initial startup: ${e.initialStartup}, ${e.initialStartup?`state: ${e.timers.ellapsedWindowRestoreState}ms, widget: ${e.timers.ellapsedBrowserWindowCreate}ms, show: ${e.timers.ellapsedWindowMaximize}ms`:""}`]),i.push(["app.isReady => window.loadUrl()",e.timers.ellapsedWindowLoad,"[main]",`initial startup: ${e.initialStartup}`]),i.push(["window.loadUrl() => begin to import(workbench.desktop.main.js)",e.timers.ellapsedWindowLoadToRequire,"[main->renderer]",x(e.windowKind)]),i.push(["import(workbench.desktop.main.js)",e.timers.ellapsedRequire,"[renderer]",`cached data: ${e.didUseCachedData?"YES":"NO"}`]),i.push(["wait for window config",e.timers.ellapsedWaitForWindowConfig,"[renderer]",void 0]),i.push(["init storage (global & workspace)",e.timers.ellapsedStorageInit,"[renderer]",void 0]),i.push(["init workspace service",e.timers.ellapsedWorkspaceServiceInit,"[renderer]",void 0]),S&&(i.push(["init settings and global state from settings sync service",e.timers.ellapsedRequiredUserDataInit,"[renderer]",void 0]),i.push(["init keybindings, snippets & extensions from settings sync service",e.timers.ellapsedOtherUserDataInit,"[renderer]",void 0])),i.push(["register extensions & spawn extension host",e.timers.ellapsedExtensions,"[renderer]",void 0]),i.push(["restore viewlet",e.timers.ellapsedViewletRestore,"[renderer]",e.viewletId]),i.push(["restore panel",e.timers.ellapsedPanelRestore,"[renderer]",e.panelId]),i.push(["restore & resolve visible editors",e.timers.ellapsedEditorRestore,"[renderer]",`${e.editorIds.length}: ${e.editorIds.join(", ")}`]),i.push(["create workbench contributions",e.timers.ellapsedWorkbenchContributions,"[renderer]",`${(r.get(l.Starting)?.length??0)+(r.get(l.Starting)?.length??0)} blocking startup`]),i.push(["overall workbench load",e.timers.ellapsedWorkbench,"[renderer]",void 0]),i.push(["workbench ready",e.ellapsed,"[main->renderer]",void 0]),i.push(["renderer ready",e.timers.ellapsedRenderer,"[renderer]",void 0]),i.push(["shared process connection ready",e.timers.ellapsedSharedProcesConnected,"[renderer->sharedprocess]",void 0]),i.push(["extensions registered",e.timers.ellapsedExtensionsReady,"[renderer]",void 0]),t.heading(2,"Performance Marks"),t.table(["What","Duration","Process","Info"],i)}_addExtensionsTable(t){const e=[],r=[],i=this._extensionService.getExtensionsStatus();for(const a in i){const{activationTimes:o}=i[a];o&&(o.activationReason.startup?e.push([a,o.activationReason.startup,o.codeLoadingTime,o.activateCallTime,o.activateResolvedTime,o.activationReason.activationEvent,o.activationReason.extensionId.value]):r.push([a,o.activationReason.startup,o.codeLoadingTime,o.activateCallTime,o.activateResolvedTime,o.activationReason.activationEvent,o.activationReason.extensionId.value]))}const n=e.concat(r);n.length>0&&(t.heading(2,"Extension Activation Stats"),t.table(["Extension","Eager","Load Code","Call Activate","Finish Activate","Event","By"],n))}_addPerfMarksTable(t,e,r){if(!r)return;const i=[];let n=-1,a=0;for(const{name:o,startTime:d}of r){const f=n!==-1?d-n:0;a+=f,i.push([o,Math.round(d),Math.round(f),Math.round(a)]),n=d}t&&e.heading(2,t),e.table(["Name","Timestamp","Delta","Total"],i)}_addWorkbenchContributionsPerfMarksTable(t){t.heading(2,"Workbench Contributions Blocking Restore");const e=b.as(I.Workbench).timings;t.li(`Total (LifecyclePhase.Starting): ${e.get(l.Starting)?.length} (${e.get(l.Starting)?.reduce((i,n)=>i+n[1],0)}ms)`),t.li(`Total (LifecyclePhase.Ready): ${e.get(l.Ready)?.length} (${e.get(l.Ready)?.reduce((i,n)=>i+n[1],0)}ms)`),t.blank();const r=this._timerService.getPerformanceMarks().find(i=>i[0]==="renderer")?.[1].filter(i=>i.name.startsWith("code/willCreateWorkbenchContribution/1")||i.name.startsWith("code/didCreateWorkbenchContribution/1")||i.name.startsWith("code/willCreateWorkbenchContribution/2")||i.name.startsWith("code/didCreateWorkbenchContribution/2"));this._addPerfMarksTable(void 0,t,r)}_addRawPerfMarks(t){for(const[e,r]of this._timerService.getPerformanceMarks()){t.heading(2,`Raw Perf Marks: ${e}`),t.value+="```\n",t.value+=`Name	Timestamp	Delta	Total
`;let i=-1,n=0;for(const{name:a,startTime:o}of r){const d=i!==-1?o-i:0;n+=d,t.value+=`${a}	${o}	${d}	${n}
`,i=o}t.value+="```\n"}}_addResourceTimingStats(t){const e=performance.getEntriesByType("resource").map(r=>[r.name,r.duration]);e.length&&(t.heading(2,"Resource Timing Stats"),t.table(["Name","Duration"],e))}};h=v([s(0,C),s(1,$),s(2,P),s(3,M),s(4,E),s(5,W),s(6,L),s(7,V),s(8,N)],h);class q{value="";heading(t,e){return this.value+=`${"#".repeat(t)} ${e}

`,this}blank(){return this.value+=`
`,this}li(t){return this.value+=`* ${t}
`,this}table(t,e){this.value+=this.toMarkdownTable(t,e)}toMarkdownTable(t,e){let r="";const i=[];return t.forEach((n,a)=>{i[a]=n.length}),e.forEach(n=>{n.forEach((a,o)=>{typeof a>"u"&&(a=n[o]="-");const d=a.toString().length;i[o]=Math.max(d,i[o])})}),t.forEach((n,a)=>{r+=`| ${n+" ".repeat(i[a]-n.toString().length)} `}),r+=`|
`,t.forEach((n,a)=>{r+=`| ${"-".repeat(i[a])} `}),r+=`|
`,e.forEach(n=>{n.forEach((a,o)=>{typeof a<"u"&&(r+=`| ${a+" ".repeat(i[o]-a.toString().length)} `)}),r+=`|
`}),r}}export{c as PerfviewContrib,m as PerfviewInput};
