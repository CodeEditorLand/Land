{
  "version": 3,
  "sources": ["../../../../../../../../../Dependency/Land/Dependency/Editor/Source/vs/workbench/contrib/chat/browser/chatContentParts/chatAttachmentsContentPart.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as dom from '../../../../../base/browser/dom.js';\nimport { Disposable, DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { IChatRequestVariableEntry } from '../../common/chatModel.js';\nimport { Emitter } from '../../../../../base/common/event.js';\nimport { IInstantiationService } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { ResourceLabels } from '../../../../browser/labels.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { FileKind, IFileService } from '../../../../../platform/files/common/files.js';\nimport { Range } from '../../../../../editor/common/core/range.js';\nimport { basename, dirname } from '../../../../../base/common/path.js';\nimport { localize } from '../../../../../nls.js';\nimport { ChatResponseReferencePartStatusKind, IChatContentReference } from '../../common/chatService.js';\nimport { IOpenerService } from '../../../../../platform/opener/common/opener.js';\nimport { IHoverService } from '../../../../../platform/hover/browser/hover.js';\nimport { createInstantHoverDelegate } from '../../../../../base/browser/ui/hover/hoverDelegateFactory.js';\n\nexport class ChatAttachmentsContentPart extends Disposable {\n\tprivate readonly attachedContextDisposables = this._register(new DisposableStore());\n\n\tprivate readonly _onDidChangeVisibility = this._register(new Emitter<boolean>());\n\tprivate readonly _contextResourceLabels = this.instantiationService.createInstance(ResourceLabels, { onDidChangeVisibility: this._onDidChangeVisibility.event });\n\n\tconstructor(\n\t\tprivate readonly variables: IChatRequestVariableEntry[],\n\t\tprivate readonly contentReferences: ReadonlyArray<IChatContentReference> = [],\n\t\tpublic readonly domNode: HTMLElement = dom.$('.chat-attached-context'),\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t\t@IOpenerService private readonly openerService: IOpenerService,\n\t\t@IHoverService private readonly hoverService: IHoverService,\n\t\t@IFileService private readonly fileService: IFileService\n\t) {\n\t\tsuper();\n\n\t\tthis.initAttachedContext(domNode);\n\t}\n\n\tprivate initAttachedContext(container: HTMLElement) {\n\t\tdom.clearNode(container);\n\t\tthis.attachedContextDisposables.clear();\n\t\tdom.setVisibility(Boolean(this.variables.length), this.domNode);\n\t\tconst hoverDelegate = this.attachedContextDisposables.add(createInstantHoverDelegate());\n\n\t\tthis.variables.forEach(async (attachment) => {\n\t\t\tconst widget = dom.append(container, dom.$('.chat-attached-context-attachment.show-file-icons'));\n\t\t\tconst label = this._contextResourceLabels.create(widget, { supportIcons: true, hoverDelegate, hoverTargetOverrride: widget });\n\t\t\tconst file = URI.isUri(attachment.value) ? attachment.value : attachment.value && typeof attachment.value === 'object' && 'uri' in attachment.value && URI.isUri(attachment.value.uri) ? attachment.value.uri : undefined;\n\t\t\tconst range = attachment.value && typeof attachment.value === 'object' && 'range' in attachment.value && Range.isIRange(attachment.value.range) ? attachment.value.range : undefined;\n\n\t\t\tconst correspondingContentReference = this.contentReferences.find((ref) => typeof ref.reference === 'object' && 'variableName' in ref.reference && ref.reference.variableName === attachment.name);\n\t\t\tconst isAttachmentOmitted = correspondingContentReference?.options?.status?.kind === ChatResponseReferencePartStatusKind.Omitted;\n\t\t\tconst isAttachmentPartialOrOmitted = isAttachmentOmitted || correspondingContentReference?.options?.status?.kind === ChatResponseReferencePartStatusKind.Partial;\n\n\t\t\tlet ariaLabel: string | undefined;\n\n\t\t\tif (file && attachment.isFile) {\n\t\t\t\tconst fileBasename = basename(file.path);\n\t\t\t\tconst fileDirname = dirname(file.path);\n\t\t\t\tconst friendlyName = `${fileBasename} ${fileDirname}`;\n\n\t\t\t\tif (isAttachmentOmitted) {\n\t\t\t\t\tariaLabel = range ? localize('chat.omittedFileAttachmentWithRange', \"Omitted: {0}, line {1} to line {2}.\", friendlyName, range.startLineNumber, range.endLineNumber) : localize('chat.omittedFileAttachment', \"Omitted: {0}.\", friendlyName);\n\t\t\t\t} else if (isAttachmentPartialOrOmitted) {\n\t\t\t\t\tariaLabel = range ? localize('chat.partialFileAttachmentWithRange', \"Partially attached: {0}, line {1} to line {2}.\", friendlyName, range.startLineNumber, range.endLineNumber) : localize('chat.partialFileAttachment', \"Partially attached: {0}.\", friendlyName);\n\t\t\t\t} else {\n\t\t\t\t\tariaLabel = range ? localize('chat.fileAttachmentWithRange3', \"Attached: {0}, line {1} to line {2}.\", friendlyName, range.startLineNumber, range.endLineNumber) : localize('chat.fileAttachment3', \"Attached: {0}.\", friendlyName);\n\t\t\t\t}\n\n\t\t\t\tlabel.setFile(file, {\n\t\t\t\t\tfileKind: FileKind.FILE,\n\t\t\t\t\thidePath: true,\n\t\t\t\t\trange,\n\t\t\t\t\ttitle: correspondingContentReference?.options?.status?.description\n\t\t\t\t});\n\t\t\t} else if (attachment.isImage) {\n\t\t\t\tariaLabel = localize('chat.imageAttachment', \"Attached image, {0}\", attachment.name);\n\n\t\t\t\tconst hoverElement = dom.$('div.chat-attached-context-hover');\n\t\t\t\thoverElement.setAttribute('aria-label', ariaLabel);\n\n\t\t\t\t// Custom label\n\t\t\t\tconst pillIcon = dom.$('div.chat-attached-context-pill', {}, dom.$('span.codicon.codicon-file-media'));\n\t\t\t\tconst textLabel = dom.$('span.chat-attached-context-custom-text', {}, attachment.name);\n\t\t\t\twidget.appendChild(pillIcon);\n\t\t\t\twidget.appendChild(textLabel);\n\n\t\t\t\tlet buffer: Uint8Array;\n\t\t\t\ttry {\n\t\t\t\t\tif (attachment.value instanceof URI) {\n\t\t\t\t\t\tconst readFile = await this.fileService.readFile(attachment.value);\n\t\t\t\t\t\tbuffer = readFile.value.buffer;\n\n\t\t\t\t\t} else {\n\t\t\t\t\t\tbuffer = attachment.value as Uint8Array;\n\t\t\t\t\t}\n\t\t\t\t\tawait this.createImageElements(buffer, widget, hoverElement);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.error('Error processing attachment:', error);\n\t\t\t\t}\n\n\t\t\t\twidget.style.position = 'relative';\n\t\t\t\tif (!this.attachedContextDisposables.isDisposed) {\n\t\t\t\t\tthis.attachedContextDisposables.add(this.hoverService.setupManagedHover(hoverDelegate, widget, hoverElement));\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconst attachmentLabel = attachment.fullName ?? attachment.name;\n\t\t\t\tconst withIcon = attachment.icon?.id ? `$(${attachment.icon.id}) ${attachmentLabel}` : attachmentLabel;\n\t\t\t\tlabel.setLabel(withIcon, correspondingContentReference?.options?.status?.description);\n\n\t\t\t\tariaLabel = localize('chat.attachment3', \"Attached context: {0}.\", attachment.name);\n\t\t\t}\n\n\t\t\tif (isAttachmentPartialOrOmitted) {\n\t\t\t\twidget.classList.add('warning');\n\t\t\t}\n\t\t\tconst description = correspondingContentReference?.options?.status?.description;\n\t\t\tif (isAttachmentPartialOrOmitted) {\n\t\t\t\tariaLabel = `${ariaLabel}${description ? ` ${description}` : ''}`;\n\t\t\t\tfor (const selector of ['.monaco-icon-suffix-container', '.monaco-icon-name-container']) {\n\t\t\t\t\tconst element = label.element.querySelector(selector);\n\t\t\t\t\tif (element) {\n\t\t\t\t\t\telement.classList.add('warning');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (file) {\n\t\t\t\twidget.style.cursor = 'pointer';\n\t\t\t\tif (!this.attachedContextDisposables.isDisposed) {\n\t\t\t\t\tthis.attachedContextDisposables.add(dom.addDisposableListener(widget, dom.EventType.CLICK, async (e: MouseEvent) => {\n\t\t\t\t\t\tdom.EventHelper.stop(e, true);\n\t\t\t\t\t\tthis.openerService.open(\n\t\t\t\t\t\t\tfile,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tfromUserGesture: true,\n\t\t\t\t\t\t\t\teditorOptions: {\n\t\t\t\t\t\t\t\t\tselection: range\n\t\t\t\t\t\t\t\t} as any\n\t\t\t\t\t\t\t});\n\t\t\t\t\t}));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\twidget.ariaLabel = ariaLabel;\n\t\t\twidget.tabIndex = 0;\n\t\t});\n\t}\n\n\t// Helper function to create and replace image\n\tprivate async createImageElements(buffer: ArrayBuffer | Uint8Array, widget: HTMLElement, hoverElement: HTMLElement) {\n\t\tconst blob = new Blob([buffer], { type: 'image/png' });\n\t\tconst url = URL.createObjectURL(blob);\n\t\tconst img = dom.$('img.chat-attached-context-image', { src: url, alt: '' });\n\t\tconst pillImg = dom.$('img.chat-attached-context-pill-image', { src: url, alt: '' });\n\t\tconst pill = dom.$('div.chat-attached-context-pill', {}, pillImg);\n\n\t\tconst existingPill = widget.querySelector('.chat-attached-context-pill');\n\t\tif (existingPill) {\n\t\t\texistingPill.replaceWith(pill);\n\t\t}\n\n\t\t// Update hover image\n\t\thoverElement.appendChild(img);\n\t}\n}\n\n"],
  "mappings": "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",
  "names": []
}
